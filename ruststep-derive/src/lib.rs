//! proc-macro for ruststep
//!
//! ```
//! pub struct Table; // moc table struct
//!
//! #[derive(Debug, Clone, PartialEq, ruststep_derive::Holder)]
//! #[holder(table = Table)]
//! pub struct A {
//!     pub x: f64,
//!     pub y: f64,
//! }
//! ```
//!
//! `#[derive(Holder)]` generates followings:
//!
//! - `AHolder` struct
//!   - naming rule is `{}Holder`
//! - `impl Holder for AHolder`
//!   - `#[holder(table = ...)]` is consumed here
//! - `impl Deserialize for AHolder`
//! - `AHolderVisitor` struct for implementing `Deserialize`
//!   - naming rule is `{}HolderVisitor`
//!   - This struct is usually generated by [serde::Deserialize] proc-macro,
//!     but their definition does not match for our cases.
//!

use proc_macro::TokenStream;
use proc_macro2::{Span, TokenStream as TokenStream2};
use proc_macro_crate::*;
use quote::{format_ident, quote};

mod for_struct;
mod holder_attr;
use holder_attr::*;

#[proc_macro_derive(Holder, attributes(holder))]
pub fn derive_holder_entry(input: TokenStream) -> TokenStream {
    derive_holder(&syn::parse(input).unwrap()).into()
}

fn holder_ident(ident: &syn::Ident) -> syn::Ident {
    format_ident!("{}Holder", ident)
}

fn holder_visitor_ident(ident: &syn::Ident) -> syn::Ident {
    format_ident!("{}HolderVisitor", ident)
}

fn ruststep_path() -> TokenStream2 {
    let path = crate_name("ruststep").unwrap();
    match path {
        FoundCrate::Itself => quote! { crate },
        FoundCrate::Name(name) => {
            let ident = syn::Ident::new(&name, Span::call_site());
            quote! { ::#ident }
        }
    }
}

fn derive_holder(ast: &syn::DeriveInput) -> TokenStream2 {
    let table = get_table_ident(ast);
    let ident = &ast.ident;
    match &ast.data {
        syn::Data::Struct(st) => {
            let def_holder_tt = for_struct::def_holder(ident, st);
            let def_visitor_tt = for_struct::def_visitor(ident, st);
            let impl_deserialize_tt = for_struct::impl_deserialize(ident);
            let impl_holder_tt = for_struct::impl_holder(ident, &table, st);
            quote! {
                #def_holder_tt
                #def_visitor_tt
                #impl_deserialize_tt
                #impl_holder_tt
            }
        }
        _ => unimplemented!("Only struct is supprted currently"),
    }
}
